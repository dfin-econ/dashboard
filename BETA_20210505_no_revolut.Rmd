---
title: "High Frequency Indicators [BETA] "
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll

---

<style>                     
.navbar {
  background-color:#004D44;
  border-color:#004D44;
}
.navbar-brand {
color:#EDECE5!important;
}
</style> 

```{r setup, include=FALSE}
library("flexdashboard")
library("plotly")
library("zoo")
library("xts")
library("dygraphs")
library("openxlsx")
library("parsedate")
library("janitor")
library("dplyr")
library("tidyverse")
library("ggplot2")
library("timetk")
library("plotly")
library("tidyverse")

fnrollsuml <- function (x) {
  if (length(x) < 14) {
    rep(NA,length(x)) 
  } else {
    rollsum(x,14,align="right",na.pad=TRUE)
  }
}


ECDCcovid <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na.strings = "", fileEncoding = "UTF-8-BOM")
ECDCcovid <- clean_names(ECDCcovid)
ECDCcovid$date_rep <- as.Date(ECDCcovid$date_rep , format = "%d/%m/%y")
COVID_EU_pop <- subset(ECDCcovid, geo_id=="IE" | geo_id=="BE" | geo_id=="BG" | geo_id=="CZ" | geo_id=="DK" | geo_id=="DE" | geo_id=="EE" | geo_id=="EL" | geo_id=="ES" | geo_id=="FR" | geo_id=="HR" | geo_id=="IT" | geo_id=="CY" | geo_id=="LV" | geo_id=="LT" | geo_id=="LU" | geo_id=="HU" | geo_id=="MT" | geo_id=="NL" | geo_id=="AT" | geo_id=="PL" | geo_id=="PT" | geo_id=="RO" | geo_id=="SI" | geo_id=="SK" | geo_id=="FI" | geo_id=="SE" | geo_id=="UK",
                       select=c(date_rep, countries_and_territories, pop_data2019))
COVID_EU_pop <- subset(COVID_EU_pop, date_rep == "2020-12-14")


COVID_EU_pop <- COVID_EU_pop %>% 
  rename(
    country = countries_and_territories,
  )
COVID_EU_pop <- COVID_EU_pop %>% 
  mutate(country = ifelse(as.character(country) == "United_Kingdom", "United.Kingdom", as.character(country)))
JHU_covid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_covid <- JHU_covid %>% gather(country, cases, -c(date))
JHU_covid <- merge(COVID_EU_pop, JHU_covid, by ="country")
JHU_covid$date_rep <- NULL

JHU_covid <- JHU_covid %>%
  group_by(country) %>%
  mutate(pop100k = pop_data2019/100000)
JHU_covid$date <- as.Date(JHU_covid$date , format = "%Y-%m-%d")
JHU_covid <- arrange(JHU_covid, date)
JHU_covid <- JHU_covid %>% 
  group_by(country)%>%
  mutate(cumcases=fnrollsuml(cases))
JHU_covid <- JHU_covid %>% 
  mutate(incidence_14day_per_100k = cumcases/pop100k)
spread_JHU <- spread(JHU_covid, country, incidence_14day_per_100k)
write.csv(spread_JHU, file="cases.csv",row.names=TRUE)

COVID_IE <- subset(JHU_covid, country=="Ireland",
                     select=c(date, incidence_14day_per_100k))
COVID_IE <- rename(COVID_IE, date = date)
COVID_IE <- arrange(COVID_IE, date)
COVID_IE <- na.omit(COVID_IE)
incidence <- COVID_IE %>%
  summarise(incidence14 =last(incidence_14day_per_100k))
incidence <- round(incidence, digits=0)

vax <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
vax <- subset(vax, location=="Ireland",
                     select=c(date, people_vaccinated))
vax <- mutate(vax, adult_vax=((people_vaccinated/3909809)*100))
vax <- vax %>%
  summarise(adult_vax=last(adult_vax))
vax <- round(vax, digits=1)


rt <- read.csv("https://raw.githubusercontent.com/crondonm/TrackingR/main/Estimates-Database/database.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
rt <-  clean_names(rt)
rt$date <- as.Date(rt$date, format="%Y-%m-%d")
rt$r <- round(rt$r,2)
rt <- subset(rt, country_region=="Ireland" & days_infectious==7)
rt_ie <- rt %>%
  summarise(r=last(r))
```


-----------------------------------------------------------------------

Summary
=============================
Row 
------------------------------------

### 14 day incidence per 100,000

```{r}
incidence=incidence
valueBox(incidence, icon = "fa-medkit", caption ='COVID-19 14 day incidence per 100k', color = "orange")
```

### Vaccines administered

```{r}
valueBox(vax, icon = "fa-syringe", caption ="Percentage of eligible population vaccinated", color= "#0090d4")

```

### Reproduction Number (estimate)

```{r}
valueBox(rt_ie, icon = "fa-registered", caption ="Estimated Reproduction Number", color= "#a3915e")

```



Column {data-width=350}
-----------------------------------------------------------------------


### Percentage of population vaccinated
```{r}
vax <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
vax_eu <- subset(vax, iso_code=="AUT" | iso_code=="BEL" | iso_code=="BGR" | iso_code=="HRV" | iso_code=="CYP" | iso_code=="CZE" | iso_code=="DNK" | iso_code=="EST" | iso_code=="FIN" | iso_code=="FRA" | iso_code=="DEU" | iso_code=="IRL" | iso_code=="ITA" | iso_code=="LVA" | iso_code=="LTU" | iso_code=="MLT" | iso_code=="PRT" | iso_code=="ROU" | iso_code=="SVK" | iso_code=="SVN" | iso_code=="ESP" | iso_code=="SWE" | iso_code=="GBR" | iso_code=="GRC" | iso_code=="HUN")
vax_eu <- vax_eu %>% group_by(location) %>%
  summarise(people_vaccinated_per_hundred=last(people_vaccinated_per_hundred))
vax_eu <- vax_eu %>% mutate( ToHighlight = ifelse( location == "Ireland", "yes", "no" ) )

vax_eu_plot <- ggplot(vax_eu, aes(x=reorder(location, people_vaccinated_per_hundred), y=people_vaccinated_per_hundred, fill=ToHighlight, text=people_vaccinated_per_hundred)) + 
  geom_bar(stat="identity") +coord_flip() +  scale_fill_manual( values = c( "yes"="#00A685", "no"="gray" ), guide = FALSE ) +theme_minimal() + theme(legend.position='none') + 
  ylab("Percentage of population vaccinated (at least one dose)") +
  xlab("")

ggplotly(vax_eu_plot, tooltip = c("text"))
```


Column {data-width=350}
-----------------------------------------------------------------------

### Oxford Stringency Index

```{r}
ox <- read.csv(url("https://github.com/OxCGRT/covid-policy-tracker/raw/master/data/timeseries/stringency_index.csv"))
ox_comp<- subset(ox, country_code=="IRL" | country_code=="GBR" | country_code=="ESP" | country_code=="ITA" | country_code=="SWE" | country_code=="USA" | country_code=="FRA" | country_code=="DEU", select = -c(country_name, X))
ox_comp1 <- data.frame(t(ox_comp[-1]))
colnames(ox_comp1) <- ox_comp[, 1]
ox_comp1$date <- rownames(ox_comp1)

ox_comp1$date <-as.Date(ox_comp1$date, format = "X%d%b%Y")


ox_xts <- tk_xts(ox_comp1, select = IRL | GBR | ESP | ITA | SWE | USA | FRA | DEU, date_var = date) 
dygraph(ox_xts)  %>%
  dyEvent("2020-03-27", "Lockdown", labelLoc = "bottom") %>%
  dyEvent("2020-08-07", "Midlands restrictions", labelLoc = "bottom") %>%
  dyEvent("2020-10-5", "Nationawide L3", labelLoc = "bottom") %>%
  dyEvent("2020-10-21", "Level 5", labelLoc = "bottom") %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.5,
              hideOnMouseOut = TRUE) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Dark2")) %>%
  dySeries("IRL", stepPlot = TRUE, strokeWidth = 5, color = "#00a685", )


```

### COVID-19  14 day Incidence per 100,000

```{r}
fnrollsuml <- function (x) {
  if (length(x) < 14) {
    rep(NA,length(x)) 
  } else {
    rollsum(x,14,align="right",na.pad=TRUE)
  }
}
ECDCcovid <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na.strings = "", fileEncoding = "UTF-8-BOM")
ECDCcovid <- clean_names(ECDCcovid)
ECDCcovid$date_rep <- as.Date(ECDCcovid$date_rep , format = "%d/%m/%y")
COVID_EU_pop <- subset(ECDCcovid, geo_id=="IE" | geo_id=="BE" | geo_id=="BG" | geo_id=="CZ" | geo_id=="DK" | geo_id=="DE" | geo_id=="EE" | geo_id=="EL" | geo_id=="FR" | geo_id=="HR" | geo_id=="IT" | geo_id=="CY" | geo_id=="LV" | geo_id=="LT" | geo_id=="LU" | geo_id=="HU" | geo_id=="MT" | geo_id=="NL" | geo_id=="AT" | geo_id=="PL" | geo_id=="PT" | geo_id=="RO" | geo_id=="SI" | geo_id=="SK" | geo_id=="FI" | geo_id=="SE" | geo_id=="UK" | geo_id=="IL",
                       select=c(date_rep, countries_and_territories, pop_data2019))
COVID_EU_pop <- subset(COVID_EU_pop, date_rep == "2020-12-14")


COVID_EU_pop <- COVID_EU_pop %>% 
  rename(
    country = countries_and_territories,
  )
COVID_EU_pop <- COVID_EU_pop %>% 
  mutate(country = ifelse(as.character(country) == "United_Kingdom", "United.Kingdom", as.character(country)))
JHU_covid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_covid <- JHU_covid %>% gather(country, cases, -c(date))
JHU_covid <- merge(COVID_EU_pop, JHU_covid, by ="country")
JHU_covid$date_rep <- NULL

JHU_covid <- JHU_covid %>%
  group_by(country) %>%
  mutate(pop100k = pop_data2019/100000)
JHU_covid$date <- as.Date(JHU_covid$date , format = "%Y-%m-%d")
JHU_covid <- arrange(JHU_covid, date)
JHU_covid <- JHU_covid %>% 
  group_by(country)%>%
  mutate(cumcases=fnrollsuml(cases))
JHU_covid <- JHU_covid %>% 
  mutate(incidence_14day_per_100k = cumcases/pop100k)
spread_cases <- subset(JHU_covid,
                       select=c(country, date, incidence_14day_per_100k))
spread_cases <- spread(spread_cases, country, incidence_14day_per_100k)
ECDC_xts <- tk_xts(spread_cases, select = Ireland | United.Kingdom | Italy | Sweden | France | Germany | Belgium, date_var = date) 
dygraph(ECDC_xts) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Dark2")) %>%
  dySeries("Ireland", strokeWidth = 5, color = "#00a685") %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.5,
              hideOnMouseOut = TRUE)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Google Mobility

```{r}
mobility <- read.csv(url("https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/google_reports/mobility_report_countries.csv"))
mobility <- clean_names(mobility)

mobility_IE <- subset(mobility, country=="Ireland" & region=="Total",
                   select=c(date, retail_and_recreation, grocery_and_pharmacy, transit_stations, workplaces, residential))


mobility_IE <- mobility_IE %>% mutate(retail_recreation = zoo::rollmeanr(retail_and_recreation, k = 7, fill = NA),
                                      grocery_pharmacy = zoo::rollmeanr(grocery_and_pharmacy, k = 7, fill = NA),
                                      public_transport = zoo::rollmeanr(transit_stations, k = 7, fill = NA),
                                      workplaces = zoo::rollmeanr(workplaces, k = 7, fill = NA),
                                      residential = zoo::rollmeanr(residential, k = 7, fill = NA)) 
mob_IE <- subset(mobility_IE, 
                      select=c(date, retail_recreation, grocery_pharmacy, public_transport, workplaces, residential))
mob_IE$date <- as.Date(mob_IE$date , format = "%Y-%m-%d")

mobility_IE <- mob_IE
mobility_IE$date <- as.Date(mobility_IE$date , format = "%Y-%m-%d")
IE_mob_xts <- tk_xts(mobility_IE, select = retail_recreation | workplaces | grocery_pharmacy | public_transport | residential, date_var = date)
dygraph(IE_mob_xts) %>% 
  dySeries("residential", strokeWidth = 3, color = "#0090d4") %>% 
  dySeries("workplaces", strokeWidth = 3, color = "#00a685") %>%
  dySeries("retail_recreation", strokeWidth = 3, color = "#a3915e") %>%
  dySeries("grocery_pharmacy", strokeWidth = 3, color = "#004D44") %>%
  dySeries("public_transport", strokeWidth = 3, color = "#dbac00") %>%
 dyRangeSelector() %>%
  dyAxis("y", label = "Change from baseline (Feb avg. per day)")


```

### Epidemiological Situation: Ireland

```{r}
fnrollsuml <- function (x) {
  if (length(x) < 14) {
    rep(NA,length(x)) 
  } else {
    rollsum(x,14,align="right",na.pad=TRUE)
  }
}


ECDCcovid <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na.strings = "", fileEncoding = "UTF-8-BOM")
ECDCcovid <- clean_names(ECDCcovid)
ECDCcovid$date_rep <- as.Date(ECDCcovid$date_rep , format = "%d/%m/%y")
COVID_EU_pop <- subset(ECDCcovid, geo_id=="IE" | geo_id=="BE" | geo_id=="BG" | geo_id=="CZ" | geo_id=="DK" | geo_id=="DE" | geo_id=="EE" | geo_id=="EL" | geo_id=="ES" | geo_id=="FR" | geo_id=="HR" | geo_id=="IT" | geo_id=="CY" | geo_id=="LV" | geo_id=="LT" | geo_id=="LU" | geo_id=="HU" | geo_id=="MT" | geo_id=="NL" | geo_id=="AT" | geo_id=="PL" | geo_id=="PT" | geo_id=="RO" | geo_id=="SI" | geo_id=="SK" | geo_id=="FI" | geo_id=="SE" | geo_id=="UK",
                       select=c(date_rep, countries_and_territories, pop_data2019))
COVID_EU_pop <- subset(COVID_EU_pop, date_rep == "2020-12-14")


COVID_EU_pop <- COVID_EU_pop %>% 
  rename(
    country = countries_and_territories,
  )
COVID_EU_pop <- COVID_EU_pop %>% 
  mutate(country = ifelse(as.character(country) == "United_Kingdom", "United.Kingdom", as.character(country)))
JHU_covid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_covid <- JHU_covid %>% gather(country, cases, -c(date))
JHU_covid <- merge(COVID_EU_pop, JHU_covid, by ="country")
JHU_covid$date_rep <- NULL

JHU_covid <- JHU_covid %>%
  group_by(country) %>%
  mutate(pop100k = pop_data2019/100000)
JHU_covid$date <- as.Date(JHU_covid$date , format = "%Y-%m-%d")
JHU_covid <- arrange(JHU_covid, date)
JHU_covid <- JHU_covid %>% 
  group_by(country)%>%
  mutate(cumcases=fnrollsuml(cases))
JHU_covid <- JHU_covid %>% 
  mutate(incidence_14day_per_100k = cumcases/pop100k)

JHU_covid1 <- subset(JHU_covid, country=="Ireland",
                    select=c(date, cases))
JHU_covid1[is.na(JHU_covid1)] <- 0
JHU_covid1<- JHU_covid1 %>%
  mutate(cum_sum = cumsum(cases))

write.csv(JHU_covid1, file="cumulcases.csv",row.names=TRUE)



JHU_covid <- subset(JHU_covid, country=="Ireland",
                    select=c(date, incidence_14day_per_100k))



JHU_deaths <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_deaths.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_deaths <- JHU_deaths %>% gather(country, deaths, -c(date))
JHU_deaths <- merge(COVID_EU_pop, JHU_deaths, by ="country")
JHU_deaths$date_rep <- NULL

JHU_deaths <- JHU_deaths %>%
  group_by(country) %>%
  mutate(pop100k = pop_data2019/100000)
JHU_deaths$date <- as.Date(JHU_deaths$date , format = "%Y-%m-%d")
JHU_deaths <- arrange(JHU_deaths, date)
JHU_deaths <- JHU_deaths %>% 
  group_by(country)%>%
  mutate(cumdeaths=fnrollsuml(deaths))
JHU_deaths <- JHU_deaths %>% 
  mutate(deaths_14day_per_100k = cumdeaths/pop100k)
spread_deaths <- subset(JHU_deaths,
                     select=c(country, date, deaths_14day_per_100k))
spread_deaths <- spread(spread_deaths, country, deaths_14day_per_100k)
write.csv(spread_deaths, file="deaths.csv", row.names=TRUE)

JHU_deaths <- subset(JHU_deaths, country=="Ireland",
                     select=c(date, deaths_14day_per_100k))

JHU_IE <- merge(JHU_deaths, JHU_covid, by="date")


JHU_IE <- JHU_IE %>% 
  rename(
    "14 day fatalities per 100,000" = deaths_14day_per_100k,
    "14 day incidence rate per 100,000" = incidence_14day_per_100k
  )

IE_xts <- tk_xts(JHU_IE, select = `14 day fatalities per 100,000` |  `14 day incidence rate per 100,000`, date_var = date) 
dygraph(IE_xts) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Dark2")) %>%
  dyAxis("y", label = "Cases")%>%
  dyAxis("y2", label = "Deaths ") %>%
  dySeries("14 day fatalities per 100,000", axis=('y2'))



```

-----------------------------------------------------------------------

Mobility 
=============================
```{r setup1, include=FALSE}
residentialsum <- mobility_IE %>%
  summarise(residential =last(residential))
residentialsum <- round(residentialsum, digits=0)


workplacessum <- mobility_IE %>%
  summarise(workplaces =last(workplaces))
workplacessum <- round(workplacessum, digits=0)


retailsum <- mobility_IE %>%
  summarise(retail_recreation =last(retail_recreation))
retailsum <- round(retailsum, digits=0)

transportsum <- mobility_IE %>%
  summarise(transportsum =last(public_transport))
transportsum <- round(transportsum, digits=0)
```

Row 
------------------------------------

### Workplaces

```{r}
valueBox(workplacessum, icon = "fa-building", caption ='Workplaces', color = "#00a685")
```

### Public Transport

```{r}

valueBox(transportsum, icon = "fa-bus-alt", caption ="Public Transport", color= "#dbac00")
```

### Retail and Recreation

```{r}

valueBox(value = retailsum,icon = "fa-shopping-bag",caption = "Retail and Recreation", color = "#a3915e")
```


### Residential

```{r}

valueBox(value = residentialsum,icon = "fa-home",caption = "Residential", color =  "#0090d4")
```


Column {data-height=800}
-----------------------------------------------------------------------

### Google Mobility Data
```{r}

mobility_IE <- read.csv('mobility.csv')
mobility_IE$date <- as.Date(mobility_IE$date , format = "%Y-%m-%d")
IE_mob_xts <- tk_xts(mobility_IE, select = retail_recreation | workplaces | grocery_pharmacy | public_transport | residential, date_var = date)
dygraph(IE_mob_xts) %>% 
  dySeries("residential", strokeWidth = 3, color = "#0090d4") %>% 
  dySeries("workplaces", strokeWidth = 3, color = "#00a685") %>%
  dySeries("retail_recreation", strokeWidth = 3, color = "#a3915e") %>%
  dySeries("grocery_pharmacy", strokeWidth = 3, color = "#004D44") %>%
  dySeries("public_transport", strokeWidth = 3, color = "#dbac00") %>%
 dyRangeSelector() %>%
  dyAxis("y", label = "Change from baseline (Feb avg. per day)")
```



Central Bank 
=============================


Row {data-height=600}
------------------------------------------------------------------------------
### Spending Index (March 2020 =1)
```{r}
url_cbi <- "https://www.centralbank.ie/docs/default-source/statistics/data-and-analysis/credit-and-banking-statistics/credit-and-debit-card-statistics/credit-and-debit-card-statistics-data/table-a-13-2-daily-card-payments-data.xlsx"
cbi <- read.xlsx(url_cbi, startRow = 5)
cbi$X1 <- convertToDate(cbi$X1, origin = "1900-01-01")
cbi <- clean_names(cbi)
cbi <- cbi %>% 
  rename(
    date = x1,
  )
cbi_total <- subset(cbi, select = c (date, spending_on_all_cards))  
cbi_total <- cbi_total %>% mutate(spend_ma = zoo::rollmean(spending_on_all_cards, k = 7, fill = NA, align = c("right")))
cbi_total <- cbi_total %>% mutate(cbi_index = spend_ma/spend_ma[7])
cbi_total <-  cbi_total %>%
  filter(date > "2020-03-06") 
cbi_total <- subset(cbi_total, select = c(date, cbi_index))  
cbi_xts <- tk_xts(cbi_total, date_var = date)
dygraph(cbi_xts)

```

Row {data-height=500}
------------------------------------------------------------------------------

### Online, POS, ATM Spending (Indexed to Oct 2020)

```{r}
cbi_online <- cbi %>% 
  rename(
    online = o_w_online_spending_card_not_present,
    offline = o_w_in_store_spending_card_present,
    atm = o_w_atm_withdrawals
  )
 cbi_online$online <- as.numeric(cbi_online$online)
 cbi_online$offline <- as.numeric(cbi_online$offline)
 cbi_online$atm <- as.numeric(cbi_online$atm)
 cbi_online <- cbi_online %>% mutate(spend_online = zoo::rollmean(online, k = 7, fill = NA, align = c("right"))) %>%
   mutate(spend_pos = zoo::rollmean(offline, k = 7, fill = NA, align = c("right"))) %>%
   mutate(spend_atm = zoo::rollmean(atm, k = 7, fill = NA, align = c("right"))) 
 


cbi_online <-  cbi_online %>%
  filter(date > "2020-10-01") 
cbi_online <- cbi_online %>%
  group_by(date) %>%
  mutate(total_cat = spend_online + spend_pos + spend_atm)
cbi_online <- cbi_online %>%
  mutate(online_proportion = spend_online/total_cat) %>%
  mutate(atm_proportion = spend_atm/total_cat) %>%
  mutate(pos_proportion = spend_pos/total_cat)

cbi_online <-  subset(cbi_online, select = c(date, online_proportion, atm_proportion, pos_proportion))  
cbi_online_xts <- tk_xts(cbi_online, date_var = date)
dygraph(cbi_online_xts)
  
```

### Spending by category (Indexed to Oct 2020)

```{r}
cbi_cats <-  cbi %>%
  filter(date > "2020-10-01")

cbi_cats$groceries_perishables <- as.numeric(cbi_cats$groceries_perishables)
cbi_cats$other_retail <- as.numeric(cbi_cats$other_retail)
cbi_cats$transport <- as.numeric(cbi_cats$transport)
cbi_cats$accommodation <- as.numeric(cbi_cats$accommodation)
cbi_cats$restaurants_dining <- as.numeric(cbi_cats$restaurants_dining)


cbi_cats <- cbi_cats %>% mutate(other_retail_ma = zoo::rollmeanr(other_retail, k = 7, fill = NA),
                                transport_ma = zoo::rollmeanr(transport, k = 7, fill = NA),
                                accommodation_ma = zoo::rollmeanr(accommodation, k = 7, fill = NA),
                                restaurants_dining_ma = zoo::rollmeanr(restaurants_dining, k = 7, fill = NA),
                                groceries_perishables_ma = zoo::rollmeanr(groceries_perishables, k = 7, fill = NA))

cbi_cats <-  cbi_cats %>%
  filter(date > "2020-10-07")

cbi_cats <- cbi_cats %>% 
  mutate(other_retail = other_retail_ma/other_retail_ma[1]) %>% 
  mutate(accommodation = accommodation_ma/accommodation_ma[1])%>%
  mutate(transport = transport_ma/transport_ma[1]) %>%
  mutate(restaurants_dining = restaurants_dining_ma/restaurants_dining_ma[1]) %>% 
  mutate(groceries_perishables = groceries_perishables_ma/groceries_perishables_ma[1])

cbi_cats <- subset(cbi_cats, select = c(date, other_retail, accommodation, transport, restaurants_dining, groceries_perishables))  
cbi_cats_xts <- tk_xts(cbi_cats, date_var = date)
dygraph(cbi_cats_xts)

```


 COVID-19 Data
=============================
Row 
-----------------------------------------
### Estimated Reproduction Number for Ireland (Arroyo-Marioli et al, 2020)
```{r}

rt <-  clean_names(rt)
rt$date <- as.Date(rt$date, format="%Y-%m-%d")
rt$r <- round(rt$r,2)
rt$ci_65_l <- round(rt$ci_65_l,2)
rt$ci_65_u <- round(rt$ci_65_u,3)

rt <- subset(rt, country_region=="Ireland" & days_infectious==7)

rplot <- ggplot(data=rt, aes(x=date, y=r, group = 1, text=paste("</br> R Number:", r,
                                                     "</br> 65% Lower Bound: ", ci_65_l,
                                                     "</br> 65% Upper Bound: ", ci_65_u))) + geom_line()
rplot <- rplot + geom_ribbon(aes(ymin=ci_65_l, ymax=ci_65_u), linetype=2, alpha=0.1) 
ggplotly(rplot, tooltip =c("text")) 

```

### 7 day average cases: Ireland

```{r}
fnrollsuml <- function (x) {
  if (length(x) < 7) {
    rep(NA,length(x)) 
  } else {
    rollsum(x,7,align="right",na.pad=TRUE)
  }
}


JHU_covid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_covid <- JHU_covid %>% gather(country, cases, -c(date))

JHU_covid$date <- as.Date(JHU_covid$date , format = "%Y-%m-%d")
JHU_covid <- arrange(JHU_covid, date)
JHU_covid <- JHU_covid %>% 
  group_by(country)%>%
  mutate(cumcases=fnrollsuml(cases))
JHU_covid <- JHU_covid %>% 
  mutate(incidence_14day_per_100k = cumcases/7)

JHU_covid1 <- subset(JHU_covid, country=="Ireland",
                    select=c(date, cases))
JHU_covid1[is.na(JHU_covid1)] <- 0


JHU_covid <- subset(JHU_covid, country=="Ireland",
                    select=c(date, incidence_14day_per_100k))


JHU_IE <-JHU_covid


JHU_IE <- JHU_IE %>% 
  rename(
    "7 day average cases" = incidence_14day_per_100k
  )

IE_xts <- tk_xts(JHU_IE, date_var = date) 
dygraph(IE_xts) %>%
  dySeries("7 day average cases", strokeWidth = 3, color = "#00a685")

```

Row 
-----------------------------------------
### 14 day cumulative cases per 100,000 [JHU]
```{r}
fnrollsuml <- function (x) {
  if (length(x) < 14) {
    rep(NA,length(x)) 
  } else {
    rollsum(x,14,align="right",na.pad=TRUE)
  }
}

ECDCcovid <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na.strings = "", fileEncoding = "UTF-8-BOM")
ECDCcovid <- clean_names(ECDCcovid)
ECDCcovid$date_rep <- as.Date(ECDCcovid$date_rep , format = "%d/%m/%y")
COVID_EU_pop <- subset(ECDCcovid, geo_id=="IE" | geo_id=="BE" | geo_id=="BG" | geo_id=="CZ" | geo_id=="DK" | geo_id=="DE" | geo_id=="EE" | geo_id=="EL" | geo_id=="ES" | geo_id=="FR" | geo_id=="HR" | geo_id=="IT" | geo_id=="CY" | geo_id=="LV" | geo_id=="LT" | geo_id=="LU" | geo_id=="HU" | geo_id=="MT" | geo_id=="NL" | geo_id=="AT" | geo_id=="PL" | geo_id=="PT" | geo_id=="RO" | geo_id=="SI" | geo_id=="SK" | geo_id=="FI" | geo_id=="SE" | geo_id=="UK",
                       select=c(date_rep, countries_and_territories, pop_data2019))
COVID_EU_pop <- subset(COVID_EU_pop, date_rep == "2020-12-14")


COVID_EU_pop <- COVID_EU_pop %>% 
  rename(
    country = countries_and_territories,
  )
COVID_EU_pop <- COVID_EU_pop %>% 
  mutate(country = ifelse(as.character(country) == "United_Kingdom", "United.Kingdom", as.character(country)))
JHU_covid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_covid <- JHU_covid %>% gather(country, cases, -c(date))
JHU_covid <- merge(COVID_EU_pop, JHU_covid, by ="country")
JHU_covid$date_rep <- NULL

JHU_covid <- JHU_covid %>%
  group_by(country) %>%
  mutate(pop100k = pop_data2019/100000)
JHU_covid$date <- as.Date(JHU_covid$date , format = "%Y-%m-%d")
JHU_covid <- arrange(JHU_covid, date)
JHU_covid <- JHU_covid %>% 
  group_by(country)%>%
  mutate(cumcases=fnrollsuml(cases))
JHU_covid <- JHU_covid %>% 
  mutate(incidence_14day_per_100k = cumcases/pop100k)
spread_cases <- subset(JHU_covid,
                        select=c(country, date, incidence_14day_per_100k))
spread_cases <- spread(spread_cases, country, incidence_14day_per_100k)
write.csv(spread_cases, file="cases.csv",row.names=TRUE)

casesxt <- tk_xts(spread_cases, date_var = date)
dygraph(casesxt) %>%
  dySeries("Ireland", strokeWidth = 3, color = "#00a685") %>%
  dyLegend(width = 700)

```


Row 
-----------------------------------------
### 14 day cumulative deaths per million [JHU]
```{r}
JHU_deaths<- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_deaths_per_million.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
JHU_deaths <- JHU_deaths %>% gather(country, deaths_per_mill, -c(date))
JHU_deaths <- merge(COVID_EU_pop, JHU_deaths, by ="country")
JHU_deaths$date_rep <- NULL


JHU_deaths$date <- as.Date(JHU_deaths$date , format = "%Y-%m-%d")
JHU_deaths <- arrange(JHU_deaths, date)
JHU_deaths<- JHU_deaths %>% 
  group_by(country)%>%
  mutate(day_14_deaths_per_mill=fnrollsuml(deaths_per_mill))

spread_deaths <- subset(JHU_deaths,
                       select=c(country, date, day_14_deaths_per_mill))
spread_deaths <- spread(spread_deaths, country, day_14_deaths_per_mill)
deathsxts <- tk_xts(spread_deaths, date_var = date)
dygraph(deathsxts) %>%
  dySeries("Ireland", strokeWidth = 5, color = "#00a685")

```

Row 
-----------------------------------------
### Hospitalised cases per 100,000 [ECDC]
```{r}
COVID_EU_pop <- subset(ECDCcovid, geo_id=="IE" | geo_id=="BE" | geo_id=="CZ" | geo_id=="DK" | geo_id=="DE" | geo_id=="EL" | geo_id=="ES" | geo_id=="FR" | geo_id=="HR" | geo_id=="IT" | geo_id=="NL" | geo_id=="AT" | geo_id=="PT"| geo_id=="FI" | geo_id=="SE" | geo_id=="UK",
                         select=c(date_rep, countries_and_territories, pop_data2019))
COVID_EU_pop <- subset(COVID_EU_pop, date_rep == "2020-12-14")

COVID_EU_pop <- COVID_EU_pop %>% 
  rename(
    country = countries_and_territories,
  )
ECDCcovidhospital <- read.csv("https://opendata.ecdc.europa.eu/covid19/hospitalicuadmissionrates/csv/data.csv", na.strings = "", fileEncoding = "UTF-8-BOM")
ECDCcovidhospital <- merge(COVID_EU_pop, ECDCcovidhospital, by ="country")
ECDC_hospital_occupancy <- subset(ECDCcovidhospital, indicator == "Daily hospital occupancy")
ECDC_hospital_occupancy  <- ECDC_hospital_occupancy  %>% 
  mutate(pop100k=pop_data2019/100000)
ECDC_hospital_occupancy  <- ECDC_hospital_occupancy  %>% 
  mutate(occupancy_per_100k=value/pop100k)
ECDC_hospital_occupancy<- subset(ECDC_hospital_occupancy, select=c(country, date, occupancy_per_100k))
spread_hosp <- spread(ECDC_hospital_occupancy, country, occupancy_per_100k)
spread_hosp$date <- as.Date(spread_hosp$date)
hospxt <- tk_xts(spread_hosp, date_var = Date)
dygraph(hospxt) %>%
  dySeries("Ireland", strokeWidth = 3, color = "#00a685")
write.csv(spread_hosp, file="hosp.csv")
```

### ICU Patients per 100,000 [ECDC]
```{r}
ECDC_ICU_occupancy <- subset(ECDCcovidhospital, indicator == "Daily ICU occupancy")
ECDC_ICU_occupancy  <- ECDC_ICU_occupancy  %>% 
  mutate(pop100k=pop_data2019/100000)
ECDC_ICU_occupancy  <- ECDC_ICU_occupancy  %>% 
  mutate(ICUoccupancy_per_100k=value/pop100k)
ECDC_ICU_occupancy<- subset(ECDC_ICU_occupancy, select=c(country, date, ICUoccupancy_per_100k))
spread_ICU <- spread(ECDC_ICU_occupancy, country, ICUoccupancy_per_100k)
spread_ICU$date <- as.Date(spread_ICU$date)
ICUxt <- tk_xts(spread_ICU, date_var = date)
dygraph(ICUxt) %>%
  dySeries("Ireland", strokeWidth = 3, color = "#00a685") 
```

Row 
-----------------------------------------
### Tests carried out per thousand population [OWID]
```{r}
testing <- read.csv(url("https://github.com/owid/covid-19-data/raw/master/public/data/testing/covid-testing-all-observations.csv"))
testing <- clean_names(testing)
testing <- subset(testing, iso_code=="AUT" | iso_code=="BEL" | iso_code=="CZE" | iso_code=="DNK" | iso_code=="EST" | iso_code=="FIN" | iso_code=="FRA" | iso_code=="DEU" | iso_code=="IRL" | iso_code=="ITA"| iso_code=="NLD" | iso_code=="PRT" | iso_code=="ESP" | iso_code=="SWE" | iso_code=="GBR")
testing <-  subset(testing, entity!="France - people tested")
testing <-  subset(testing, entity!="Italy - people tested")
testing <-  subset(testing, entity!="Poland - people tested")
testing$date <- as.Date(testing$date , format = "%Y-%m-%d")
testing <- testing %>% group_by(iso_code) %>%
  mutate(change_in_cumulative_total_per_thousand_ma = zoo::rollmeanr(daily_change_in_cumulative_total_per_thousand, 7, fill = NA))
testing <- testing %>% group_by(iso_code) %>%
  mutate(positivity_rate_ma = zoo::rollmeanr(short_term_positive_rate, 7, fill = NA))



testing_tests_per_thousand <- subset(testing, select=c(date, iso_code, x7_day_smoothed_daily_change_per_thousand))
testing_tests_per_thousand <- spread(testing_tests_per_thousand, iso_code, x7_day_smoothed_daily_change_per_thousand)
testingxt <- tk_xts(testing_tests_per_thousand, date_var = date)
dygraph(testingxt) %>%
  dySeries("IRL", strokeWidth = 3, color = "#00a685")

```

### Test positivity rates [OWID]
```{r}
testing_positive_rate <- subset(testing, select=c(date, iso_code, positivity_rate_ma))
testing_positive_rate <- spread(testing_positive_rate, iso_code, positivity_rate_ma)

positivext <- tk_xts(testing_positive_rate, date_var = date)
dygraph(positivext) %>%
  dySeries("IRL", strokeWidth = 3, color = "#00a685") %>%
  dyAxis("y", label = "proportion of tests returned positive")

```

 Vaccinations
=============================
Row 
-----------------------------------------
### Percentage of population vaccinated
```{r}
vax <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
vax_eu <- subset(vax, iso_code=="AUT" | iso_code=="BEL" | iso_code=="BGR" | iso_code=="HRV" | iso_code=="CYP" | iso_code=="CZE" | iso_code=="DNK" | iso_code=="EST" | iso_code=="FIN" | iso_code=="FRA" | iso_code=="DEU" | iso_code=="IRL" | iso_code=="ITA" | iso_code=="LVA" | iso_code=="LTU" | iso_code=="MLT" | iso_code=="PRT" | iso_code=="ROU" | iso_code=="SVK" | iso_code=="SVN" | iso_code=="ESP" | iso_code=="SWE" | iso_code=="GBR" | iso_code=="GRC" | iso_code=="HUN")
vax_eu <- vax_eu %>% group_by(location) %>%
  summarise(people_vaccinated_per_hundred=last(people_vaccinated_per_hundred))
vax_eu <- vax_eu %>% mutate( ToHighlight = ifelse( location == "Ireland", "yes", "no" ) )

vax_eu_plot <- ggplot(vax_eu, aes(x=reorder(location, people_vaccinated_per_hundred), y=people_vaccinated_per_hundred, fill=ToHighlight, text=people_vaccinated_per_hundred)) + 
  geom_bar(stat="identity") +coord_flip() +  scale_fill_manual( values = c( "yes"="#00A685", "no"="gray" ), guide = FALSE ) +theme_minimal() + theme(legend.position='none') + 
  ylab("Percentage of population vaccinated (at least one dose)") +
  xlab("")

vax_eu_plot
ggplotly(vax_eu_plot, tooltip = c("text"))
spread_vax <- subset(vax_eu,
                       select=c(location, people_vaccinated_per_hundred))
write.csv(spread_vax, file="vax.csv",row.names=TRUE)
```

Row 
-----------------------------------------
### Percentage of population fully vaccinated
```{r}
vax <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
vax_eu <- subset(vax, iso_code=="AUT" | iso_code=="BEL" | iso_code=="BGR" | iso_code=="HRV" | iso_code=="CYP" | iso_code=="CZE" | iso_code=="DNK" | iso_code=="EST" | iso_code=="FIN" | iso_code=="FRA" | iso_code=="DEU" | iso_code=="IRL" | iso_code=="ITA" | iso_code=="LVA" | iso_code=="LTU" | iso_code=="MLT" | iso_code=="PRT" | iso_code=="ROU" | iso_code=="SVK" | iso_code=="SVN" | iso_code=="ESP" | iso_code=="SWE" | iso_code=="GBR" | iso_code=="GRC" | iso_code=="HUN")
vax_eu <- vax_eu %>% group_by(location) %>%
  summarise(people_fully_vaccinated_per_hundred=last(people_fully_vaccinated_per_hundred))
vax_eu <- vax_eu %>% mutate( ToHighlight = ifelse( location == "Ireland", "yes", "no" ) )

vax_eu_plot1 <- ggplot(vax_eu, aes(x=reorder(location, people_fully_vaccinated_per_hundred), y=people_fully_vaccinated_per_hundred, fill=ToHighlight, text=people_fully_vaccinated_per_hundred)) + 
  geom_bar(stat="identity") +coord_flip() +  scale_fill_manual( values = c( "yes"="#00A685", "no"="gray" ), guide = FALSE ) +theme_minimal() + theme(legend.position='none') + 
  ylab("Percentage of population fully vaccinated ") +
  xlab("")

vax_eu_plot1
ggplotly(vax_eu_plot1, tooltip = c("text"))
write.csv(vax_eu, file="fully_vax.csv")
```

### Daily vaccinations per million
```{r}
vax <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
vax_eu <- subset(vax, iso_code=="AUT" | iso_code=="BEL" | iso_code=="BGR" | iso_code=="HRV" | iso_code=="CYP" | iso_code=="CZE" | iso_code=="DNK" | iso_code=="EST" | iso_code=="FIN" | iso_code=="FRA" | iso_code=="DEU" | iso_code=="IRL" | iso_code=="ITA" | iso_code=="LVA" | iso_code=="LTU" | iso_code=="MLT" | iso_code=="PRT" | iso_code=="ROU" | iso_code=="SVK" | iso_code=="SVN" | iso_code=="ESP" | iso_code=="SWE" | iso_code=="GBR" | iso_code=="GRC" | iso_code=="HUN")
vax_eu <- vax_eu %>% group_by(location) %>%
  summarise(daily_vaccinations_per_million=last(daily_vaccinations_per_million))
vax_eu <- vax_eu %>% mutate( ToHighlight = ifelse( location == "Ireland", "yes", "no" ) )

vax_eu_plot2 <- ggplot(vax_eu, aes(x=reorder(location, daily_vaccinations_per_million), y=daily_vaccinations_per_million, fill=ToHighlight, text=daily_vaccinations_per_million)) + 
  geom_bar(stat="identity") +coord_flip() +  scale_fill_manual( values = c( "yes"="#00A685", "no"="gray" ), guide = FALSE ) +theme_minimal() + theme(legend.position='none') + 
  ylab("Daily Vaccinations per million, 7 day MA") +
  xlab("")

vax_eu_plot2
ggplotly(vax_eu_plot2, tooltip = c("text"))
```
